"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.transformStream = void 0;
const transformStream = (stream, transformer, options) => {
    const accumulate = options?.onEnd ? true : false;
    return new ReadableStream({
        async start(c) {
            const accumulated = [];
            try {
                options?.onStart?.();
                for await (const chunk of stream) {
                    options?.onRawChunk?.(chunk);
                    const content = transformer(chunk);
                    if (content) {
                        // Only accumulate if onEnd is provided to avoid unnecessary memory usage.
                        accumulate && accumulated.push(content);
                        options?.onTransformedChunk?.(content);
                        c.enqueue(content);
                    }
                }
            }
            catch (error) {
                options?.onError?.(error);
                c.error(error);
            }
            finally {
                options?.onEnd?.({ accumulated });
                c.close();
            }
        },
    });
};
exports.transformStream = transformStream;
//# sourceMappingURL=utils.js.map